/*
	Copyright 2020. (노성철, nsch78@nate.com, nsch@naver.com) All right reserved
*/
package icmp

import . "unsafe"
import . "콘솔"
import . "util"
import . "net/ipv4"

var 콘솔 = T콘솔{}
/////////////////////////////////////////////////////////////////////////////////////////////
//
//		인터넷제어메시지규약 = InternetControlMessageProtocol = ICMP
//
/////////////////////////////////////////////////////////////////////////////////////////////
type 인터넷제어메시지규약_메시지_임시저장공간 struct{
	유형 byte
	코드 byte
	
	검사합 [2]byte
	자료 [4] byte
}

var 인터넷제어메시지규약_크기 int = 64

type T인터넷제어메시지규약_메시지 struct{
	유형 uint8
	코드 uint8
	
	검사합 uint16
	자료 uint32
}
func (자신 *T인터넷제어메시지규약_메시지) M초기화(임시저장공간 인터넷제어메시지규약_메시지_임시저장공간){
	자신.유형 = 임시저장공간.유형
	자신.코드 = 임시저장공간.코드
	
	자신.검사합 = Uint16_R(ArrayToUint16(임시저장공간.검사합))
	자신.자료 = Uint32_R(ArrayToUint32(임시저장공간.자료))
}

func (자신 *T인터넷제어메시지규약_메시지) M버퍼설정(임시저장공간 *인터넷제어메시지규약_메시지_임시저장공간){
	임시저장공간.유형 = 자신.유형
	임시저장공간.코드 = 자신.코드

	임시저장공간.검사합 = Uint16ToArray(자신.검사합)
	임시저장공간.자료 = Uint32ToArray(자신.자료)
}

/////////////////////////////////////////////////////////////////////////////////////////////
type T인터넷제어메시지규약 struct{
	T인터넷규약_처리기
}
func (자신 *T인터넷제어메시지규약) M초기화(후단부 T인터넷규약_제공자){
	자신.T인터넷규약_처리기.M초기화(후단부, 자신, 0x01)
}
func (자신 *T인터넷제어메시지규약) M인터넷규약_받은동시(출발지아이피_역순 uint32, 목적지아이피_역순 uint32, 자료주소 uintptr, 크기 uint32) bool{
	if 크기 < uint32(인터넷제어메시지규약_크기) {
		return false
	}

	var 임시저장공간 *인터넷제어메시지규약_메시지_임시저장공간 = (*인터넷제어메시지규약_메시지_임시저장공간)(Pointer(자료주소))
	var 메시지 T인터넷제어메시지규약_메시지 = T인터넷제어메시지규약_메시지{}
	메시지.M초기화(*임시저장공간)

	switch 메시지.유형 {
		case 0:
			break

		case 8:
			메시지.유형 = 0
			메시지.검사합 = 0
			메시지.M버퍼설정(임시저장공간)
			메시지.검사합 = 자신.T인터넷규약_처리기.M제공자_갖기().M검사합((*([4096]uint16))(Pointer(자료주소)), uint32(인터넷제어메시지규약_크기))
			메시지.M버퍼설정(임시저장공간)
			return true
			break
	}
	return false
}

func (자신 *T인터넷제어메시지규약) M반향응답_요청하기(ip_be uint32) bool{

	var 메시지 T인터넷제어메시지규약_메시지 = T인터넷제어메시지규약_메시지{}
	var 임시저장공간 인터넷제어메시지규약_메시지_임시저장공간 = 인터넷제어메시지규약_메시지_임시저장공간{}

	메시지.유형 = 8
	메시지.코드 = 0
	메시지.자료 = 0x3713
	메시지.검사합 = 0
	메시지.M버퍼설정(&임시저장공간)
	메시지.검사합 =  자신.T인터넷규약_처리기.M제공자_갖기().M검사합((*([4096]uint16))(Pointer(&임시저장공간)), uint32(인터넷제어메시지규약_크기))
	메시지.M버퍼설정(&임시저장공간)

	var 자료주소 uintptr = uintptr(Pointer(&임시저장공간))
	자신.T인터넷규약_처리기.M패킷보내기(ip_be, 0x01, 자료주소, uint32(인터넷제어메시지규약_크기))

	return false
}
