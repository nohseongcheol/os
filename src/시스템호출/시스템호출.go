/*
        Copyright 2020. (노성철, nsch78@nate.com, nsch@naver.com) All right reserved
*/

package 시스템호출

import . "unsafe"
import . "interrupt"
import . "작업관리자"

import . "단말기"

type T시스템호출 struct{
	T개입중단_처리기
}

func M시스템호출_개입중단(eax, ebx, ecx, edx, esi, edi uint32)

func M시스템호출(매개변수들 ...uint32){
	길이 := len(매개변수들)
	
	switch(길이){
		case 1:
			M시스템호출_개입중단(매개변수들[0], 0, 0, 0, 0, 0)
		case 2:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 0, 0, 0, 0)
		case 3:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 매개변수들[2], 0, 0, 0)
		case 4:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 매개변수들[2], 매개변수들[3], 0, 0)
		case 5:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 매개변수들[2], 매개변수들[3], 매개변수들[4], 0)
		case 6:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 매개변수들[2], 매개변수들[3], 매개변수들[4], 매개변수들[5])
		default:
			M시스템호출_개입중단(매개변수들[0], 매개변수들[1], 매개변수들[2], 매개변수들[3], 매개변수들[4], 매개변수들[5])
	}
}


var 개입중단_처리기 func(*T시스템호출, uint32) uint32
func (자신 *T시스템호출) M초기화(관리자 *T개입중단_관리자){
	
	개입중단_처리기 = (*T시스템호출).M개입중단_처리기

	var 주소 uintptr = uintptr(Pointer(&개입중단_처리기))

	자신.T개입중단_처리기.M초기화(0x80, uintptr(Pointer(관리자)), 주소)
}

var 단말기 T단말기 = T단말기{}

func(자신 *T시스템호출) M개입중단_처리기(확장스택포인터 uint32) uint32{
	
	중앙처리장치_상태 := (*T중앙처리장치_상태)(Pointer(uintptr(확장스택포인터)))
	
	switch(중앙처리장치_상태.Eax){
		case 4:
			var 임시 = *(*string)(Pointer(uintptr(중앙처리장치_상태.Ebx)))
			단말기.M출력(임시)
		case 5:
		default:
			단말기.M출력XY("[syscall:", 1, 20)
			단말기.M출력(확장스택포인터)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Eax)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Ebx)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Ecx)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Edx)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Esi)
			단말기.M출력(":") 
			단말기.M출력(중앙처리장치_상태.Edi)
			단말기.M출력("]")
	}
	return 확장스택포인터
}
